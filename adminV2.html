<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‡∏£‡∏∞‡∏ö‡∏ö AUTODIDACTIC (Admin) - Users with userId & password</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" defer></script>

  <style>
    :root {
      --red-600:#c72828;
      --red-700:#9b1f1f;
      --card-bg:#fff;
      --muted:#666;
    }
    *{ box-sizing:border-box }
    body{
      font-family:'Prompt',system-ui;
      margin:0; padding:0;
      background:linear-gradient(to bottom,#fff,#fdeaea);
      color:#111;
    }

    header{
      background:linear-gradient(90deg,#c00,#f44336);
      color:#fff;
      padding:12px 20px;
      display:flex; justify-content:space-between; align-items:center;
      position:sticky; top:0; z-index:10;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
    }
    .logo-title{display:flex; gap:12px; align-items:center;}
    .logo-title img{width:50px; background:#fff8; padding:5px; border-radius:8px;}

    .nav-btn{color:#fff; background:#0003; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:700;}

    main{max-width:1100px; margin:24px auto; padding:0 16px;}
    .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:18px;}
    @media(max-width:880px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card-bg);
      border-radius:12px;
      padding:16px;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      border:2px solid #c7282815;
    }

    .btn{
      background:var(--red-600); color:#fff; border:none;
      padding:8px 14px; border-radius:10px; cursor:pointer;
      font-weight:700;
      box-shadow:0 6px 14px rgba(0,0,0,0.1);
    }
    .danger{ background:#ff5050; }
    .small-muted{font-size:13px; color:#666;}

    .list-item{
      background:#fff6f6; border:1px solid #c7282825;
      padding:10px; border-radius:8px; margin-bottom:10px;
    }

    /* Scroll lists */
    #eventList, #leaveList, #userList {
      max-height: 350px;
      overflow-y: auto;
      padding-right:6px;
    }
    #eventList::-webkit-scrollbar,
    #leaveList::-webkit-scrollbar,
    #userList::-webkit-scrollbar{ width:6px; }
    #eventList::-webkit-scrollbar-thumb,
    #leaveList::-webkit-scrollbar-thumb,
    #userList::-webkit-scrollbar-thumb{
      background:#c00; border-radius:4px;
    }
    #eventList::-webkit-scrollbar-track,
    #leaveList::-webkit-scrollbar-track,
    #userList::-webkit-scrollbar-track{
      background:#ffe5e5;
    }

    footer{
      background:linear-gradient(90deg,#c00,#f44336);
      color:#fff; padding:10px; text-align:center; margin-top:30px;
    }

    input[type="text"], input[type="password"], select {
      padding:8px; border-radius:8px; border:1px solid #ddd;
      font-size:14px;
    }

    .muted-note { font-size:12px; color:#7a7a7a; margin-top:6px; }
  </style>
</head>
<body>

<header>
  <div class="logo-title">
    <img src="ad_logo-Photoroom.png" alt="logo" />
    <div>
      <div style="font-weight:800; font-size:18px;">üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ AUTODIDACTIC (Admin)</div>
      <div style="font-size:12px; color:#eee;">Dashboard ‚Äì ‡∏£‡∏ß‡∏° Users (name, password, userId) ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</div>
    </div>
  </div>
  <nav><a href="calendar_admin.html" class="nav-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></nav>
</header>

<main>
  <div class="grid">

    <!-- EVENTS -->
    <section class="card">
      <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>
      <div id="eventList">‚è≥ Loading...</div>
    </section>

    <!-- LEAVES -->
    <section class="card">
      <h3>üèñ ‡∏ß‡∏±‡∏ô‡∏•‡∏≤</h3>
      <div id="leaveList">‚è≥ Loading...</div>
    </section>

    <!-- USERS -->
    <section class="card" style="grid-column:1 / -1;">
      <h3>üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Users)</h3>

      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:8px; align-items:center;">
        <input id="userName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (name)" style="flex:1;">
        <input id="userPassword" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (password)" style="width:220px;">
        <input id="userUserId" type="text" placeholder="userId (optional)" style="width:220px;">
        <button id="addUserBtn" class="btn">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
      <div class="muted-note">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà userId ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ document id ‡πÄ‡∏õ‡πá‡∏ô userId ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>

      <div id="userList" style="margin-top:12px;">‚è≥ Loading...</div>
    </section>

    <!-- NAMES -->
    <section class="card" style="grid-column:1 / -1;">
      <h3>üìë ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Worker / Assigner</h3>

      <div style="display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap;">
        <input id="newName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠..." style="padding:8px; border:1px solid #ddd; border-radius:8px;">
        <select id="nameType" style="padding:8px; border-radius:8px;">
          <option value="workers">‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</option>
          <option value="assigners">‡∏Ñ‡∏ô‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</option>
        </select>
        <button id="addNameBtn" class="btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠</button>
      </div>

      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px;">
        <div><h4 class="small-muted">Workers</h4><div id="workerList">‚è≥ Loading...</div></div>
        <div><h4 class="small-muted">Assigners</h4><div id="assignerList">‚è≥ Loading...</div></div>
      </div>

    </section>

    <!-- HOLIDAY -->
    <section class="card" style="grid-column:1 / -1;">
      <h3>üè¢ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h3>
      <div id="holidayCalendar" style="min-height:300px;"></div>
    </section>

  </div>
</main>

<footer>¬© 2025 AUTODIDACTIC</footer>

<!-- FIREBASE + APP LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    addDoc,
    deleteDoc,
    updateDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /* --------------- config --------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyAXayBBLVSohNCIsnlWRq6rD0BUbW70MGk",
    authDomain: "events-666d6.firebaseapp.com",
    projectId: "events-666d6",
    storageBucket: "events-666d6.firebasestorage.app",
    messagingSenderId: "589078390914",
    appId: "1:589078390914:web:480ce96137ffac835aac9b",
    measurementId: "G-97GD75S814"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const $ = id => document.getElementById(id);

  /* --------------- helper: ensure defaults (optional) --------------- */
  async function ensureDefaultDocs(){
    const w = await getDocs(collection(db,"workers"));
    if (w.empty) {
      await addDoc(collection(db,"workers"), { name: "User A" });
      await addDoc(collection(db,"workers"), { name: "User B" });
    }
    const a = await getDocs(collection(db,"assigners"));
    if (a.empty) await addDoc(collection(db,"assigners"), { name: "Admin" });

    const l = await getDocs(collection(db,"leaves"));
    if (l.empty) {
      await addDoc(collection(db,"leaves"), {
        name: "User A", reason: "‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°", start: "2025-01-10", end: "2025-01-10"
      });
    }

    const h = await getDocs(collection(db,"holidays"));
    if (h.empty) {
      await addDoc(collection(db,"holidays"), { name: "‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà", date: "2025-01-01" });
    }

    const e = await getDocs(collection(db,"events"));
    if (e.empty) {
      await addDoc(collection(db,"events"), {
        jobNumber: "JOB-000",
        job: "‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
        location: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà",
        details: "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
        orderDate: "2025-01-01",
        start: "2025-01-01",
        end: "2025-01-02",
        workers: ["User A"],
        assigners: ["Admin"],
        jobTypes: ["‡∏ó‡∏î‡∏™‡∏≠‡∏ö"],
        contactPerson: "Contact",
        phoneNumber: "0000000000",
        status: "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
      });
    }
  }

  /* --------------- EVENTS --------------- */
  async function loadEvents(){
    const box = $("eventList");
    box.innerHTML = "";
    const snap = await getDocs(collection(db,"events"));
    if(snap.empty) { box.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</i>"; return; }

    snap.forEach(d=>{
      const v = d.data();
      box.insertAdjacentHTML("beforeend",`
        <div class="list-item">
          <b>${v.jobNumber || '-'}</b> ‚Äî ${v.location || '-'}<br>
          <span class="small-muted">${v.start || '-'} ‚Üí ${v.end || '-'}</span>
        </div>
      `);
    });
  }

  /* --------------- LEAVES --------------- */
  async function loadLeaves(){
    const box = $("leaveList");
    box.innerHTML = "";
    const snap = await getDocs(collection(db,"leaves"));
    if(snap.empty) { box.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏•‡∏≤</i>"; return; }

    snap.forEach(d=>{
      const v = d.data();
      box.insertAdjacentHTML("beforeend",`
        <div class="list-item">
          <b>${v.name}</b> ‚Äî <span class="small-muted">${v.reason}</span><br>
          <span class="small-muted">${v.start} ‚Üí ${v.end}</span><br>
          <div style="margin-top:8px;">
            <button class="btn danger" onclick="delLeave('${d.id}')">üóë ‡∏•‡∏ö</button>
          </div>
        </div>
      `);
    });
  }

  window.delLeave = async (id)=>{
    if(!confirm("‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤?")) return;
    await deleteDoc(doc(db,"leaves",id));
    loadLeaves();
  };

  /* --------------- USERS (name, password, userId) --------------- */
  async function loadUsers(){
    const box = $("userList");
    box.innerHTML = "";
    const snap = await getDocs(collection(db,"users"));
    if(snap.empty) { box.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</i>"; return; }

    snap.forEach(d=>{
      const v = d.data();
      // show fields name, password, userId
      const name = v.name || "-";
      const password = v.password || "-";
      const userId = v.userId || d.id;

      box.insertAdjacentHTML("beforeend",`
        <div class="list-item">
          <div><b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${escapeHtml(name)}</div>
          <div><b>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</b> ${escapeHtml(password)}</div>
          <div><b>UserID:</b> ${escapeHtml(userId)}</div>
          <div style="margin-top:8px;">
            <button class="btn" onclick="editUserPrompt('${d.id}','${escapeJs(name)}','${escapeJs(password)}','${escapeJs(userId)}')">‚úè ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn danger" onclick="delUser('${d.id}')">üóë ‡∏•‡∏ö</button>
          </div>
        </div>
      `);
    });
  }

  window.delUser = async (id)=>{
    if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    await deleteDoc(doc(db,"users",id));
    loadUsers();
  };

  // add user: if userId input empty, after addDoc update the document to set userId = doc.id
  $("addUserBtn").addEventListener("click", async ()=>{
    const name = $("userName").value.trim();
    const password = $("userPassword").value; // allow empty? we require non-empty
    let userId = $("userUserId").value.trim();

    if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (name)");
    if(!password) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (password)");

    // add
    const ref = await addDoc(collection(db,"users"), { name, password, userId: userId || "" });

    // if user didn't provide userId, set it to doc id
    if(!userId){
      await updateDoc(doc(db,"users", ref.id), { userId: ref.id });
    }

    // clear inputs
    $("userName").value = "";
    $("userPassword").value = "";
    $("userUserId").value = "";

    loadUsers();
  });

  // Prompt-based edit (name, password, userId)
  window.editUserPrompt = async (docId, oldName, oldPassword, oldUserId) => {
    // decode escaped values
    const namePrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠ (name):", decodeURIComponent(oldName));
    if (namePrompt === null) return; // cancel
    const passPrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (password):", decodeURIComponent(oldPassword));
    if (passPrompt === null) return;
    const uidPrompt = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç userId:", decodeURIComponent(oldUserId));
    if (uidPrompt === null) return;

    if (!namePrompt.trim()) return alert("‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");
    if (!passPrompt) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ");

    await updateDoc(doc(db,"users", docId), {
      name: namePrompt.trim(),
      password: passPrompt,
      userId: uidPrompt.trim() || docId
    });

    loadUsers();
  };

  /* --------------- WORKERS / ASSIGNERS --------------- */
  async function loadNames(){
    $("workerList").innerHTML = "";
    $("assignerList").innerHTML = "";

    const ws = await getDocs(collection(db,"workers"));
    if(ws.empty) $("workerList").innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
    ws.forEach(d=>{
      $("workerList").insertAdjacentHTML("beforeend",`
        <div class="list-item">
          ${escapeHtml(d.data().name)}
          <div style="margin-top:8px;"><button class="btn danger" onclick="delName('workers','${d.id}')">‡∏•‡∏ö</button></div>
        </div>
      `);
    });

    const as = await getDocs(collection(db,"assigners"));
    if(as.empty) $("assignerList").innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
    as.forEach(d=>{
      $("assignerList").insertAdjacentHTML("beforeend",`
        <div class="list-item">
          ${escapeHtml(d.data().name)}
          <div style="margin-top:8px;"><button class="btn danger" onclick="delName('assigners','${d.id}')">‡∏•‡∏ö</button></div>
        </div>
      `);
    });
  }

  window.delName = async (col,id)=>{
    if(!confirm("‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ?")) return;
    await deleteDoc(doc(db,col,id));
    loadNames();
  };

  $("addNameBtn").addEventListener("click", async ()=>{
    const name = $("newName").value.trim();
    const type = $("nameType").value;
    if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
    await addDoc(collection(db,type), { name });
    $("newName").value = "";
    loadNames();
  });

  /* --------------- HOLIDAY CALENDAR --------------- */
  async function loadHolidayEvents(){
    const snap = await getDocs(collection(db,"holidays"));
    const arr = [];
    snap.forEach(d=>{
      const x = d.data();
      arr.push({ id:d.id, title:x.name, start:x.date, allDay:true });
    });
    return arr;
  }

  async function initHoliday(){
    const list = await loadHolidayEvents();
    const cal = new FullCalendar.Calendar( $("holidayCalendar"), {
      initialView:"dayGridMonth",
      selectable:true,
      events:list,

      dateClick: async (info)=>{
        const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î?");
        if(!name) return;
        const ref = await addDoc(collection(db,"holidays"), { name, date:info.dateStr });
        cal.addEvent({ id:ref.id, title:name, start:info.dateStr });
      },

      eventClick: async (info)=>{
        if(!confirm(`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î "${info.event.title}" ?`)) return;
        await deleteDoc(doc(db,"holidays",info.event.id));
        info.event.remove();
      }
    });
    cal.render();
  }

  /* --------------- helpers --------------- */
  function escapeHtml(str){
    if(!str) return "";
    return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function escapeJs(str){
    if(str === undefined || str === null) return "";
    return encodeURIComponent(String(str));
  }

  /* --------------- INIT --------------- */
  (async ()=>{
    try{ await ensureDefaultDocs(); } catch(e){ console.warn("ensureDefaultDocs failed", e); }
    await loadEvents();
    await loadLeaves();
    await loadUsers();
    await loadNames();
    await initHoliday();
  })();
</script>

</body>
</html>
